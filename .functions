#!/usr/bin/env bash


# Utility function to check if $1 command exists
# Use example: if exists ls; then echo "Command exists."; else echo "Command does not exist."; fi
exists() {
    cmnd=${1:?"Please supply a command to look for."}
    command -v $cmnd >/dev/null 2>&1 && { return 0; } || { return 1; }
}

title() {
    print -Pn "\e]0;$1\a"
}

randomWallpaper() {
    wallpapers=($(ls -d ~/wallpapers/*))
    index=$(($RANDOM % ${#wallpapers[@]} ))
    wallpaper=${wallpapers[$index]}
    echo ${wallpaper}
}

setWallpaper() {
  wallpaper_file="$1"

  if [ "$wallpaper_file" != '' ] && [ -f "$wallpaper_file" ]; then
    rm ~/.wallpaper
    ln -s "$wallpaper_file" ~/.wallpaper
  fi

  if [ -f $HOME/.wallpaper ]; then
    feh --bg-fill $HOME/.wallpaper
  else
    setRandomWallpaper
  fi
}

setRandomWallpaper() {
    # Without the echo $RANDOM, result is always the same...
    echo $RANDOM
    wallpaper=$(randomWallpaper)
    echo "Setting wallpaper to ${wallpaper}"
    feh --bg-fill "${wallpaper}"
}

getInstalledPackages() {
    packages=$(pacman -Qm; yaourt -Qm; yaourt -Qmd; yaourt -Qme; yaourt -Qmed)
    echo ${packages} | sort | uniq

}

install() {
    yaourt --needed -S $@
}

uninstall() {
    yaourt -R $@
}


detect_os() {

    ## OS and Architecture

    if [ -f /etc/os-release ]; then
        # freedesktop.org and systemd
        . /etc/os-release
        OS=$NAME
        VER=$VERSION_ID
    elif type lsb_release >/dev/null 2>&1; then
        # linuxbase.org
        OS=$(lsb_release -si)
        VER=$(lsb_release -sr)
    elif [ -f /etc/lsb-release ]; then
        # For some versions of Debian/Ubuntu without lsb_release command
        . /etc/lsb-release
        OS=$DISTRIB_ID
        VER=$DISTRIB_RELEASE
    elif [ -f /etc/debian_version ]; then
        # Older Debian/Ubuntu/etc.
        OS=Debian
        VER=$(cat /etc/debian_version)
    elif [ -f /etc/SuSe-release ]; then
        # Older SuSE/etc.
        ...
    elif [ -f /etc/redhat-release ]; then
        # Older Red Hat, CentOS, etc.
        ...
    else
        # Fall back to uname, e.g. "Linux <version>", also works for BSD, etc.
        OS=$(uname -s)
        VER=$(uname -r)
    fi

}


# @see https://github.com/kepkin/dev-shell-essentials/blob/master/highlight.sh
highlight() {
    declare -A fg_color_map
    fg_color_map[black]=30
    fg_color_map[red]=31
    fg_color_map[green]=32
    fg_color_map[yellow]=33
    fg_color_map[blue]=34
    fg_color_map[magenta]=35
    fg_color_map[cyan]=36

    fg_c=$(echo -e "\e[1;${fg_color_map[$1]}m")
    c_rs=$'\e[0m'
    sed -u s"/$2/$fg_c\0$c_rs/g"
}


setup_lsi() {

    if exists ls-i;
    then
        LS_COLORS=$(ls_colors_generator)

        run_ls() {
            ls-i --color=auto -w $(tput cols) "$@"
        }

        run_dir() {
            dir-i --color=auto -w $(tput cols) "$@"
        }

        run_vdir() {
            vdir-i --color=auto -w $(tput cols) "$@"
        }
        #alias ls="run_ls"
        #alias dir="run_dir"
        #alias vdir="run_vdir"
    fi
}


grepc() {
    pattern=$1
    shift
    if [ ! -z $2 ]; then
    esc=$(printf "\0\$2")
    shift
    else
    esc=$(printf "\033")
    fi
    sed -E 's"'"$pattern"'"'$esc'[32m&'$esc'[0m"g' "$@"
}


histcmd() {
    fc -l 1 |  awk '{line=$1; $1=""; CMD_LINE[$0]=line; CMD[$0]++;count++; for (a in CMD)print CMD[a] " " CMD_LINE[a] " " a;}' | sort -rn
}


r(){
    source $HOME/.zshrc
}


function validate-yml()
{
	#!/bin/bash

	#
	# Efstathios Xagoraris <sxagoraris@gmail.com>
	# Validate YAML files using ruby
	#


	if [ $# -eq 0 ]
	  then
		echo "Please provide a yaml file as argument eg $0 file.yaml"
		exit 1
	fi

	ruby -ryaml -e "YAML.parse(File.open('${1}'))"

	if [[ $? -ne 0 ]]
	  then
		echo "$1 is not valid YAML"
	  else
		echo "$1 is a valid YAML"
	fi
}

current_tmux_window() {
    display_time=$(tmux show-options -g display-time | grep -o '[0-9]*')

    tmux set-option -g display-time 1
    tmux display-message
    tmux set-option -g display-time $display_time

    export TMUX_WINDOW=$(tmux show-messages | tail -1 | grep -o 'current pane \([0-9]\)' | grep -o '[0-9]*')
    echo $TMUX_WINDOW
}

notify-on-error() {
    tmp_file=$(mktemp)\
    ARGS="$@"
    eval $ARGS 2>$tmp_file
    result=$?

    if [ $result -ne 0 ]; then
        error_content="$(cat $tmp_file)"
        echo $error_content
        notify-send -u critical -i status/important "Command failed!" "$ARGS\n$error_content"
    fi
}

notify-finished() {
    ARGS="$@"
    result=$?
    notify-on-error $ARGS
    if [ $result -eq 0 ]; then
        notify-send "Command Finished!" "$ARGS"
    fi
}

webdev () {
    action="$1"
    version="$2"
    service="$3"

    if [ -z "$action" ]; then
        echo "Please provide the action as the first parameter (up|stop|logs)"
        exit 2
    fi

    if [ -z "$version" ] && [ "$action" != 'stop' ]; then
        echo "Please provide the version as the second parameter (56|71|72)"
        exit 3
    fi

    cd "$DOCKER_REPO_LOCATION"

    if [ "$action" = "up" ]; then
        echo "Stopping web[0-9]* containers"
        docker ps -f "name=web[0-9]*" --format "{{.ID}}" | xargs docker kill
        cd "$DOCKER_REPO_LOCATION/Web${version}"
        echo "Upping ${version}..."
        docker-compose -f minimal.yml up -d --force-recreate
    elif [ "$action" = "stop" ]; then
        echo "Stopping web[0-9]* containers"
        docker ps -f "name=web[0-9]*" --format "{{.ID}}" | xargs docker kill
    elif [ "$action" = "logs" ]; then
        cd "$DOCKER_REPO_LOCATION/Web${version}"
        docker-compose logs --tail 100 -f $service
    else
        echo "Action ${action} is not recognized..."
        exit 4
    fi
}

ip_address() {
    ip route get 1 | awk '{print $NF;exit}'
}

write_apm_to_file() {
  apm list --installed --bare > ~/dotfiles/apm-packages.txt
}





### Functions used in link.sh


function installZshPlugin()
{
	pluginUrl="$1"
	pluginDir="$2"

	if [ ! -d "$HOME/.oh-my-zsh/custom/plugins/$pluginDir" ]; then
		echo "Installing ZSH plugin '$pluginDir'"
		git clone $pluginUrl ~/.oh-my-zsh/custom/plugins/$pluginDir
	else
		echo "ZSH plugin '$pluginDir' is already installed"
	fi

}


function installZshTheme()
{
	pluginUrl="$1"
	pluginDir="$2"

	if [ ! -f "$HOME/.oh-my-zsh/custom/themes/$pluginDir" ]; then
		echo "Installing ZSH theme '$pluginDir'"
		mkdir -p  ~/.oh-my-zsh/custom/themes/
		cd  ~/.oh-my-zsh/custom/themes/
		curl -fLo "$pluginDir" "$pluginUrl"
	else
		echo "ZSH theme '$pluginDir' is already installed"
	fi

}

fontsAdded=0
function installFont()
{
	fontUrl="$1"
	fontName="$2"
	if [ "$(uname)" = 'Darwin' ]; then
		mkdir -p ~/Library/Fonts
		cd ~/Library/Fonts
	else
		mkdir -p ~/.local/share/fonts
		cd ~/.local/share/fonts
	fi

	if [ ! -f "$fontName" ]; then
		curl -fLo "$fontName" "$fontUrl"
		fontsAdded=1
    deleteWindowsFonts
	fi
}

function installFontsFromZip()
{
	fontUrl="$1"
	fontName="$2"
	if [ "$(uname)" = 'Darwin' ]; then
		mkdir -p ~/Library/Fonts
		cd ~/Library/Fonts
	else
		mkdir -p ~/.local/share/fonts
		cd ~/.local/share/fonts
	fi

	if [ ! -d "$fontName" ]; then
		rm -f "/tmp/$fontName.zip"
    	curl -fLo "/tmp/$fontName.zip" "$fontUrl"
		unzip "/tmp/$fontName.zip" -d "$fontName"
		fontsAdded=1
    deleteWindowsFonts
	fi
}

function deleteWindowsFonts() {
  if [ "$(uname)" = 'Darwin' ]; then
		DIR=~/Library/Fonts
	else
		DIR=~/.local/share/fonts
	fi
  find $DIR -iname '*windows*' -delete
}

function installGtkTheme()
{
	if [[ "$(uname -s)" == *"Linux"* ]]; then
		themeUrl="$1"
		themeName="$2"
		mkdir -p ~/.themes | true
		cd ~/.themes
		if [ ! -d "$themeName" ]; then
			tmp_dir=$(mktemp -d)
			rm -f "/tmp/$themeName.zip"
			curl -fLo "/tmp/$themeName.zip" "$themeUrl"
			cd "${tmp_dir}"
			unzip "/tmp/$themeName.zip"
			mkdir -p "$HOME/.themes/$themeName"
			mv "${tmp_dir}"/*/** "$HOME/.themes/$themeName"
			rm -rf "${tmp_dir}"
		fi
	fi
}

function installPeco()
{
	if [ ! -f "/usr/local/bin/peco" ]; then
		echo "Installing Peco binary"
		url="https://github.com/peco/peco/releases/download/v0.5.1/peco_"

		platform=$(uname -s | awk '{print tolower($0)}')
		url+="$platform"
		url+="_amd64.tar.gz"
		rm -f /tmp/peco.tar.gz
		curl -fLo "/tmp/peco.tar.gz" "$url"
		cd /tmp
		tar -xzf "/tmp/peco.tar.gz" "peco_${platform}_amd64/peco"
		sudo cp "/tmp/peco_${platform}_amd64/peco" /usr/local/bin/peco
		rm -rf /tmp/peco*
	else
		echo "Peco binary already installed"
	fi
}

function getJetbrainsPluginZipUrl() {
    pluginName="$1"
    pluginBaseUrl="https://plugins.jetbrains.com/"
    requestUrl="${pluginBaseUrl}/plugin/${pluginName}"

    newUrl=$(curl "${requestUrl}" | grep -E -o '/plugin/download\?updateId=[0-9]+')

    echo "${pluginBaseUrl}${newUrl}"
}

function getJetbrainsPluginPaths() {
    productName="$1"

    echo $( find ~ -type d -name 'plugins' 2>/dev/null | grep "\.local.*${productName}")
}


function installJetbrainsPlugin() {
    set -x
    product="$1"
    zipUrl="$2"
    zipUrl=$(getJetbrainsPluginZipUrl "${zipUrl}")

    pluginDirs=$(getJetbrainsPluginPaths "${product}")

    echo "plugindirs: ${pluginDirs}"

    tmpZipFileName="/tmp/jetbrainsPlugin.zip"
    curl -L -o "${tmpZipFileName}" "${zipUrl}"
#    echo $?

    echo "after wget"
    echo "${pluginDirs[@]}"
    for pluginDir in ${pluginDirs}
    do
        echo "plugindir: ${pluginDir}"
        cd "${pluginDir}"
        unzip "${tmpZipFileName}"
    done
    set +x
}
