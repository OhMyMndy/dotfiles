#!/usr/bin/env bash

for arg do
  shift
  if [[ "$file" == "-f" ]]; then
    file="$arg"
  fi
  if [[ "$arg" = "-f" ]] || [[ "$arg" = "--file" ]]; then
    shift
    file="-f"
    continue
  fi
  set -- "$@" "$arg"
done

if [[ -n $file ]]; then
    cd "$(dirname "$file")" || exit 99;
fi

tmpfile="$(mktemp -p "$PWD")"
finish() {
    rm -f "$tmpfile"
}
trap finish 0 1 2 3 6 14 15

if [[ -z $file ]]; then
  file=docker-compose.yml
fi

if [[ -f "${file}.sh" ]]; then
    env $(grep -v '^#' .env | xargs) bash "${file}.sh" > "$tmpfile"
    docker-compose -f "$tmpfile" "$@"
    exit $?
fi

set -x
docker-compose "$@"
exit $?