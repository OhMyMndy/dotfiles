#!/usr/bin/env bash

command="$@"
set -e
TEMP="$(getopt -l "file:" "f:" -- "$@")"
eval set -- "$TEMP"

file=
while true; do
  case $1 in
    -f | --file ) file="$OPTARG"; shift 2;;
    -- ) shift; break ;;
    * ) break ;;
  esac
done

if [[ -n $file ]]; then
    cd "$("dirname $file")" || exit 99;
    command="${command/-f[ ]*$file/}"
    command="${command/--file[ ]*$file/}"
fi

tmpfile="$(tempfile -d "$PWD")"
finish() {
    rm -f "$tmpfile"
}
trap finish 0 1 2 3 6 14 15

if [[ -z $file ]]; then
  file=docker-compose.yml
  command="${command/-f[ ]*docker-compose.yml/}"
  command="${command/--file[ ]*docker-compose.yml/}"
fi

env $(grep -v '^#' .env | xargs) bash "${file}.sh" > "$tmpfile"

exec docker-compose -f "$tmpfile" $command
