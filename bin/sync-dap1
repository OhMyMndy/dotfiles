#!/usr/bin/env ruby

mount = %x[ diskutil info DAP1 | grep 'Mount Point' | grep -E -o '/Volumes/.*' | xargs echo -n ]

if mount
    remote_volume = "#{mount}/Music"
else
    remote_volume = "/dev/disk/by-label/DAP1/Music"
end

puts "Remote volume #{remote_volume}"


excludes="--exclude 'to_import' --exclude 'New Wave' --exclude '*.DS_Store' --exclude 'MpdPlaylists' --exclude 'Playlists/mpd' --exclude '.Trash-1000'"
cmd="rsync -ahrt #{excludes} --progress 192.168.10.120:/tank/media/music/ #{remote_volume}"
system cmd

Dir.chdir remote_volume + "/Playlists"
playlists = Dir.glob('**/*.m3u*')

playlists.each do |playlist|
    folder_count = playlist.scan(/\//).count + 1
    file_prefix = '../' * folder_count

    contents = File.read playlist
    contents.gsub!(file_prefix, '')
    contents.gsub!(/\.\.[\/\\]/, '')

    new_content = ''
    contents.each_line { |line| new_content << file_prefix + line }
    new_content.gsub!(/\//, '\\')
    File.write playlist, new_content
end

