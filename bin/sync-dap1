#!/usr/bin/env ruby

require 'socket'
require 'resolv-replace'

ip = Socket.ip_address_list.detect{|intf| intf.ipv4_private?}
mini_pc_ip = '192.168.10.120'

mount = %x[ diskutil info DAP1 2>/dev/null | grep 'Mount Point' | grep -E -o '/Volumes/.*' | xargs echo -n ]
mount.chomp!

if mount.length > 0
    remote_volume = "#{mount}"
else
    remote_volume = %x[ findmnt -nr -o target -S /dev/disk/by-label/DAP1 ].to_str
end
remote_volume.strip!
puts "Remote volume #{remote_volume}"

if ip.ip_address ==  mini_pc_ip
    hostname = ''
    sudo = 'sudo '
else
    sudo = ''
    hostname = "#{mini_pc_ip}:"
end


excludes="--exclude 'to_import' --exclude '*.bak' --exclude 'New Wave' --exclude '*.DS_Store' --exclude '.Trash-1000'"
cmd="#{sudo} rsync -hrt #{excludes} --progress #{hostname}/tank/media/music/ #{remote_volume}"
puts cmd
system cmd

puts "#{remote_volume}/Playlists"
Dir.chdir("#{remote_volume}/Playlists")
playlists = Dir.glob('**/*.m3u*')

playlists.each do |playlist|
    folder_count = playlist.scan(/\//).count + 1
    file_prefix = '../' * folder_count

    contents = File.read playlist
    contents.gsub!(file_prefix, '')
    contents.gsub!(/\.\.[\/\\]/, '')

    new_content = ''
    contents.each_line { |line| new_content << file_prefix + line }
    new_content.gsub!(/\//, '\\')
    File.write playlist, new_content
end
